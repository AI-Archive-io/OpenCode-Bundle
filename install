#!/usr/bin/env bash
set -euo pipefail

APP_NAME="AI-Archive MCP"
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info() { echo -e "${GREEN}[$APP_NAME] $*${NC}"; }
warn() { echo -e "${YELLOW}[$APP_NAME] $*${NC}"; }
error() { echo -e "${RED}[$APP_NAME] $*${NC}" >&2; exit 1; }

# -------- Detect OS/Arch -----------------------------------------------------

OS="$(uname -s)"
ARCH="$(uname -m)"

case "$OS" in
  Linux*) OS="linux" ;;
  Darwin*) OS="darwin" ;;
  *) error "Unsupported OS: $OS" ;;
esac

case "$ARCH" in
  x86_64) ARCH="x64" ;;
  aarch64) ARCH="arm64" ;;
  *) error "Unsupported architecture: $ARCH" ;;
esac

# -------- Install directories -------------------------------------------------

OC_DIR="$HOME/.opencode/bin"
MCP_DIR="$HOME/.ai-archive/bin"

mkdir -p "$OC_DIR" "$MCP_DIR"

# -------- Check if OpenCode is already installed ----------------------------

OPENCODE_INSTALLED=false
if command -v opencode &> /dev/null; then
  OPENCODE_INSTALLED=true
  info "OpenCode is already installed at: $(command -v opencode)"
fi

# -------- Download binaries ---------------------------------------------------

if [ "$OPENCODE_INSTALLED" = false ]; then
  info "Downloading OpenCode binary..."
  curl -L "https://github.com/sst/opencode/releases/latest/download/opencode-${OS}-${ARCH}.zip" -o oc.zip
  unzip -qo oc.zip
  mv opencode "$OC_DIR/"
  chmod +x "$OC_DIR/opencode"
  rm oc.zip
else
  info "Skipping OpenCode download (already installed)."
fi

info "Downloading AI-Archive MCP binary from GitHub releases..."

# Map OS/ARCH to GitHub release asset name
case "$OS" in
  linux)
    MCP_ASSET="ai-archive-mcp-linux-x64"
    ;;
  darwin)
    MCP_ASSET="ai-archive-macos-arm64"
    ;;
  windows)
    MCP_ASSET="ai-archive-mcp-win-x64.exe"
    ;;
  *) error "Unsupported OS for MCP asset mapping: $OS" ;;
esac

GITHUB_BASE="https://github.com/AI-Archive-io/MCP-server/releases/latest/download"
TMP_FILE="$MCP_DIR/ai-archive-mcp.tmp"

curl -L "$GITHUB_BASE/$MCP_ASSET" -o "$TMP_FILE"

# Known checksums for the current latest release - update when releases change
declare -A CHECKSUMS
CHECKSUMS[ai-archive-mcp-linux-x64]="ab0ab2df05c065125908c155fbb3a928314a39788886c3233f718dc60489be89"
CHECKSUMS[ai-archive-macos-arm64]="c3427ea1fd456c9fe3ca1d0954b58fae562cb7b21a6596c5b45277c3bee59419"
CHECKSUMS[ai-archive-mcp-win-x64.exe]="46ba24147d75564c77a52dcc4fdad7ed8ffed723a140448f22453288f598a975"

expected="${CHECKSUMS[$MCP_ASSET]:-}"
if [ -n "$expected" ]; then
  if ! command -v sha256sum >/dev/null 2>&1; then
    warn "sha256sum not found; skipping checksum verification"
  else
    actual=$(sha256sum "$TMP_FILE" | awk '{print $1}')
    if [ "$actual" != "$expected" ]; then
      rm -f "$TMP_FILE"
      error "Checksum verification failed for $MCP_ASSET (expected $expected, got $actual)"
    fi
  fi
else
  warn "No checksum for $MCP_ASSET; skipping verification"
fi

# Move downloaded file into place. Preserve .exe for Windows assets.
if [[ "$MCP_ASSET" == *.exe ]]; then
  mv "$TMP_FILE" "$MCP_DIR/ai-archive-mcp.exe"
else
  mv "$TMP_FILE" "$MCP_DIR/ai-archive-mcp"
  chmod +x "$MCP_DIR/ai-archive-mcp"
fi


# -------- Add PATH (only if we installed OpenCode) ----------------------------

if [ "$OPENCODE_INSTALLED" = false ]; then
  SHELL_RC="$HOME/.zshrc" # adjust for bash if needed

  if ! grep -q ".opencode/bin" "$SHELL_RC"; then
    echo "export PATH=\"\$HOME/.opencode/bin:\$HOME/.ai-archive/bin:\$PATH\"" >> "$SHELL_RC"
    echo "alias opencode='opencode --agent science-researcher'" >> "$SHELL_RC"
    info "PATH updated. Restart your terminal."
  fi
else
  info "Skipping PATH update (OpenCode already in PATH)."
fi

# -------- Configure OpenCode --------------------------------------------------

CFG_DIR="$HOME/.config/opencode"
mkdir -p "$CFG_DIR"

read -p "Enter your AI-Archive API key (optional): " API_KEY < /dev/tty

# Generate AI-Archive MCP config snippet
MCP_CONFIG=$(cat <<'MCCFG'
{
  "ai-archive-mcp": {
    "type": "local",
    "command": ["$MCP_DIR/ai-archive-mcp"],
    "enabled": true,
    "environment": {
      "MCP_API_KEY": "$API_KEY"
    }
  }
}
MCCFG
)

if [ "$OPENCODE_INSTALLED" = false ]; then
  # Fresh install: create complete config file
  CFG_FILE="$CFG_DIR/opencode.json"
  cat > "$CFG_FILE" <<EOF
{
  "\$schema": "https://opencode.ai/config.json",
  "mcp": {
    "ai-archive-mcp": {
      "type": "local",
      "command": ["$MCP_DIR/ai-archive-mcp"],
      "enabled": true,
      "environment": {
        "MCP_API_KEY": "$API_KEY"
      }
    }
  }
}
EOF
  info "OpenCode configured successfully at: $CFG_FILE"
else
  # OpenCode already installed: provide config snippet for manual merge
  MCP_CONFIG_FILE="$CFG_DIR/ai-archive-mcp-config.json"
  cat > "$MCP_CONFIG_FILE" <<EOF
{
  "\$schema": "https://opencode.ai/config.json",
  "mcp": {
    "ai-archive-mcp": {
      "type": "local",
      "command": ["$MCP_DIR/ai-archive-mcp"],
      "enabled": true,
      "environment": {
        "MCP_API_KEY": "$API_KEY"
      }
    }
  }
}
EOF
  warn "OpenCode is already installed. We've created a config snippet for you:"
  warn "  Location: $MCP_CONFIG_FILE"
  warn ""
  warn "Please merge this into your existing OpenCode config at:"
  warn "  $CFG_DIR/opencode.json"
  warn ""
  warn "Specifically, add the 'ai-archive-mcp' entry under the 'mcp' section."
fi

# -------- Download Agent Documentation ----------------------------------------

AGENT_CFG_DIR="$CFG_DIR/agent"
mkdir -p "$AGENT_CFG_DIR"

info "Downloading agent documentation..."

# Fetch list of agent docs from the server directory listing
AGENT_LIST=$(curl -fsSL "https://ai-archive.io/downloads/agent/" 2>/dev/null | grep -oP '(?<=href=")[^"]*\.md(?=")' || echo "")

if [ -z "$AGENT_LIST" ]; then
  warn "Could not fetch agent documentation list. Directory listing may not be enabled."
  warn "Please contact support if this issue persists."
else
  # Convert list to array to avoid stdin issues
  mapfile -t AGENT_ARRAY <<< "$AGENT_LIST"
  
  SUCCESS_COUNT=0
  for doc in "${AGENT_ARRAY[@]}"; do
    if [ -n "$doc" ]; then
      if curl -fsSL "https://ai-archive.io/downloads/agent/$doc" -o "$AGENT_CFG_DIR/$doc" 2>/dev/null; then
        info "  âœ“ $doc"
        ((SUCCESS_COUNT++)) || true
      fi
    fi
  done
  
  if [ $SUCCESS_COUNT -gt 0 ]; then
    info "Agent documentation installed to: $AGENT_CFG_DIR ($SUCCESS_COUNT files)"
  fi
fi < /dev/tty

# -------- Launch OpenCode -----------------------------------------------------

info "Launch opencode by writing 'opencode'"
# "$OC_DIR/opencode"
